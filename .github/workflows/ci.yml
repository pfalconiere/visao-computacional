name: ğŸ§ª CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

jobs:
  # ============================================
  # JOB 1: TESTES UNITÃRIOS (PYTEST)
  # ============================================
  unit-tests:
    name: ğŸ§ª Testes UnitÃ¡rios
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: ğŸ§ª Rodar testes unitÃ¡rios
        run: |
          pytest tests/ \
            -v \
            --tb=short \
            --cov=. \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html \
            --junitxml=junit/test-results.xml
      
      - name: ğŸ“Š Upload coverage para Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
      
      - name: ğŸ“‹ Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: pytest-results
          path: |
            junit/test-results.xml
            htmlcov/
      
      - name: âŒ Falha se testes falharem
        if: failure()
        run: |
          echo "âŒ Testes unitÃ¡rios falharam! Deploy cancelado."
          exit 1

  # ============================================
  # JOB 2: BUILD & HEALTH CHECK
  # ============================================
  build-and-healthcheck:
    name: ğŸ—ï¸ Build & Health Check
    runs-on: ubuntu-latest
    needs: unit-tests  # SÃ³ roda se testes unitÃ¡rios passarem
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ—ï¸ Build da aplicaÃ§Ã£o (verificar imports)
        run: |
          echo "ğŸ” Verificando imports..."
          python -c "from api import app; print('âœ… API importada com sucesso')"
          python -c "from classificador_final import ClassificadorFinal; print('âœ… Classificador importado com sucesso')"
          python -c "from celery_config import celery_app; print('âœ… Celery importado com sucesso')"
      
      - name: ğŸš€ Iniciar API (background)
        env:
          REDIS_URL: redis://localhost:6379/0
        run: |
          echo "ğŸš€ Iniciando API..."
          python api.py &
          API_PID=$!
          echo "API_PID=$API_PID" >> $GITHUB_ENV
          
          # Aguardar API inicializar (atÃ© 60s)
          echo "â³ Aguardando API inicializar..."
          for i in {1..30}; do
            if curl -s http://localhost:5000/health > /dev/null; then
              echo "âœ… API estÃ¡ online!"
              break
            fi
            echo "   Tentativa $i/30..."
            sleep 2
          done
      
      - name: âœ… Health Check
        run: |
          echo "ğŸ” Verificando saÃºde da API..."
          
          # GET /health
          response=$(curl -s http://localhost:5000/health)
          echo "Response: $response"
          
          if echo "$response" | grep -q "healthy"; then
            echo "âœ… Health check passou!"
          else
            echo "âŒ Health check falhou!"
            exit 1
          fi
      
      - name: ğŸ“Š Verificar endpoints crÃ­ticos
        run: |
          echo "ğŸ” Verificando endpoints crÃ­ticos..."
          
          # GET /stats
          curl -f http://localhost:5000/stats || exit 1
          echo "âœ… /stats OK"
          
          # GET /api-info
          curl -f http://localhost:5000/api-info || exit 1
          echo "âœ… /api-info OK"
      
      - name: ğŸ›‘ Parar API
        if: always()
        run: |
          if [ -n "$API_PID" ]; then
            kill $API_PID || true
          fi

  # ============================================
  # JOB 3: TESTES DE API (NEWMAN)
  # ============================================
  api-tests:
    name: ğŸ”¬ Testes de API (Newman)
    runs-on: ubuntu-latest
    needs: build-and-healthcheck  # SÃ³ roda se build e health check passarem
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ“¦ Setup Node.js (para Newman)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ğŸ“¦ Instalar dependÃªncias Python
        run: |
          pip install -r requirements.txt
      
      - name: ğŸ“¦ Instalar Newman
        run: |
          npm install -g newman
          npm install -g newman-reporter-htmlextra
      
      - name: ğŸš€ Iniciar API (background)
        env:
          REDIS_URL: redis://localhost:6379/0
        run: |
          python api.py &
          API_PID=$!
          echo "API_PID=$API_PID" >> $GITHUB_ENV
          
          # Aguardar API
          for i in {1..30}; do
            if curl -s http://localhost:5000/health > /dev/null; then
              break
            fi
            sleep 2
          done
      
      - name: ğŸ§ª Rodar testes Newman
        run: |
          newman run postman/document-classifier-api.postman_collection.json \
            -e postman/document-classifier.postman_environment.json \
            --reporters cli,htmlextra,junit \
            --reporter-htmlextra-export newman/report.html \
            --reporter-junit-export newman/junit-report.xml \
            --timeout-request 60000 \
            --bail \
            --color on
      
      - name: ğŸ“‹ Upload Newman report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: newman-report
          path: |
            newman/report.html
            newman/junit-report.xml
      
      - name: ğŸ›‘ Parar API
        if: always()
        run: |
          if [ -n "$API_PID" ]; then
            kill $API_PID || true
          fi
      
      - name: âŒ Falha se testes de API falharem
        if: failure()
        run: |
          echo "âŒ Testes de API falharam! Deploy cancelado."
          exit 1

  # ============================================
  # JOB 4: DEPLOY (APENAS SE TUDO PASSAR)
  # ============================================
  deploy:
    name: ğŸš€ Deploy para Render
    runs-on: ubuntu-latest
    needs: [unit-tests, build-and-healthcheck, api-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: âœ… Todos os testes passaram!
        run: |
          echo "âœ… Testes unitÃ¡rios: PASSOU"
          echo "âœ… Build & Health Check: PASSOU"
          echo "âœ… Testes de API (Newman): PASSOU"
          echo ""
          echo "ğŸš€ Pronto para deploy!"
      
      - name: ğŸŒ Deploy para Render
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          if [ -n "$RENDER_DEPLOY_HOOK" ]; then
            echo "ğŸš€ Disparando deploy no Render..."
            curl -X POST "$RENDER_DEPLOY_HOOK"
            echo "âœ… Deploy disparado!"
          else
            echo "âš ï¸ RENDER_DEPLOY_HOOK nÃ£o configurado (pule para deploy manual)"
          fi
      
      - name: â³ Aguardar deploy (2 minutos)
        run: sleep 120
      
      - name: ğŸ” Verificar deploy em produÃ§Ã£o
        run: |
          echo "ğŸ” Verificando API em produÃ§Ã£o..."
          
          # Aguardar API acordar (Render Free tier)
          for i in {1..10}; do
            if curl -s https://visao-computacional.onrender.com/health > /dev/null; then
              echo "âœ… API em produÃ§Ã£o estÃ¡ online!"
              break
            fi
            echo "   Tentativa $i/10..."
            sleep 10
          done
          
          # Health check final
          response=$(curl -s https://visao-computacional.onrender.com/health)
          if echo "$response" | grep -q "healthy"; then
            echo "âœ… Deploy bem-sucedido!"
          else
            echo "âš ï¸ API pode nÃ£o estar totalmente inicializada (normal no Render Free)"
          fi

  # ============================================
  # JOB 5: NOTIFICAÃ‡ÃƒO DE SUCESSO
  # ============================================
  success-notification:
    name: ğŸ‰ NotificaÃ§Ã£o de Sucesso
    runs-on: ubuntu-latest
    needs: [deploy]
    if: success()
    
    steps:
      - name: ğŸ‰ Deploy completo!
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "   ğŸ‰ DEPLOY BEM-SUCEDIDO! ğŸ‰"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Todos os testes passaram"
          echo "âœ… Build completo"
          echo "âœ… Health check OK"
          echo "âœ… Testes de API OK"
          echo "âœ… Deploy realizado"
          echo ""
          echo "ğŸŒ URL: https://visao-computacional.onrender.com"
          echo "ğŸ“Š Frontend: https://pfalconiere.github.io/visao-computacional/"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

